# frozen_string_literal: true

# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure('2') do |config|
  # Use Ubuntu 22.04 for testing
  config.vm.box = 'ubuntu/jammy64'

  # Configure the web server VM
  config.vm.define 'web01' do |web|
    web.vm.hostname = 'web01'
    web.vm.network 'private_network', ip: '10.0.0.1'

    # Forward SSH port (explicitly set to avoid conflicts)
    web.vm.network 'forwarded_port', guest: 22, host: 2200, id: 'ssh', auto_correct: true

    # Forward nginx port for testing (use 8081 to avoid conflicts)
    web.vm.network 'forwarded_port', guest: 80, host: 8081

    # Configure VirtualBox provider
    web.vm.provider 'virtualbox' do |vb|
      vb.name = 'kdeploy-web01'
      vb.memory = '512'
      vb.cpus = 1
    end

    # Provision: Setup SSH key and basic packages
    web.vm.provision 'shell', inline: <<-SHELL
      # Update system
      sudo apt-get update
      sudo apt-get install -y openssh-server curl

      # Setup SSH key for vagrant user
      mkdir -p /home/vagrant/.ssh
      chmod 700 /home/vagrant/.ssh

      # Allow passwordless sudo for testing
      echo "vagrant ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/vagrant

      # Ensure SSH is running
      sudo systemctl enable ssh
      sudo systemctl start ssh
    SHELL
  end

  # Optional: Configure a second web server for testing
  config.vm.define 'web02' do |web|
    web.vm.hostname = 'web02'
    web.vm.network 'private_network', ip: '10.0.0.2'

    # Forward SSH port (explicitly set to avoid conflicts)
    web.vm.network 'forwarded_port', guest: 22, host: 2201, id: 'ssh', auto_correct: true

    # Forward nginx port for testing (use 8082 to avoid conflicts)
    web.vm.network 'forwarded_port', guest: 80, host: 8082

    web.vm.provider 'virtualbox' do |vb|
      vb.name = 'kdeploy-web02'
      vb.memory = '512'
      vb.cpus = 1
    end

    web.vm.provision 'shell', inline: <<-SHELL
      sudo apt-get update
      sudo apt-get install -y openssh-server curl
      mkdir -p /home/vagrant/.ssh
      chmod 700 /home/vagrant/.ssh
      echo "vagrant ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/vagrant
      sudo systemctl enable ssh
      sudo systemctl start ssh
    SHELL
  end
end

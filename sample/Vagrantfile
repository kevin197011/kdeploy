# frozen_string_literal: true

# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure('2') do |config|
  # Use Ubuntu 24.04 for testing
  config.vm.box = 'bento/ubuntu-24.04'

  # First boot can be slow (cloud-init, etc.); increase timeout
  config.vm.boot_timeout = 600

  # Configure the web server VM
  config.vm.define 'web01' do |web|
    web.vm.hostname = 'web01'
    web.vm.network 'private_network', ip: '192.168.56.10'

    # Forward SSH port (explicitly set to avoid conflicts)
    web.vm.network 'forwarded_port', guest: 22, host: 2200, id: 'ssh', auto_correct: true

    # Forward nginx port for testing (use 8081 to avoid conflicts)
    web.vm.network 'forwarded_port', guest: 80, host: 8081

    # Forward node-exporter port for testing
    web.vm.network 'forwarded_port', guest: 9100, host: 9100

    # Configure VirtualBox provider (1024MB for Ubuntu 24.04 first boot)
    web.vm.provider 'virtualbox' do |vb|
      vb.name = 'kdeploy-web01'
      vb.memory = '1024'
      vb.cpus = 1
    end

    # Provision: Setup SSH key and basic packages
    web.vm.provision 'shell', inline: <<-SHELL
      # Update system
      sudo apt-get update
      sudo apt-get install -y openssh-server curl

      # Setup SSH key for vagrant user
      mkdir -p /home/vagrant/.ssh
      chmod 700 /home/vagrant/.ssh

      # Allow passwordless sudo for testing
      echo "vagrant ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/vagrant

      # Ensure SSH is running
      sudo systemctl enable ssh
      sudo systemctl start ssh
    SHELL
  end

  # # Optional: Configure a second web server for testing
  # config.vm.define 'web02' do |web|
  #   web.vm.hostname = 'web02'
  #   web.vm.network 'private_network', ip: '192.168.56.11'

  #   # Forward SSH port (explicitly set to avoid conflicts)
  #   web.vm.network 'forwarded_port', guest: 22, host: 2201, id: 'ssh', auto_correct: true

  #   # Forward nginx port for testing (use 8082 to avoid conflicts)
  #   web.vm.network 'forwarded_port', guest: 80, host: 8082

  #   web.vm.provider 'virtualbox' do |vb|
  #     vb.name = 'kdeploy-web02'
  #     vb.memory = '512'
  #     vb.cpus = 1
  #   end

  #   web.vm.provision 'shell', inline: <<-SHELL
  #     sudo apt-get update
  #     sudo apt-get install -y openssh-server curl
  #     mkdir -p /home/vagrant/.ssh
  #     chmod 700 /home/vagrant/.ssh
  #     echo "vagrant ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/vagrant
  #     sudo systemctl enable ssh
  #     sudo systemctl start ssh
  #   SHELL
  # end
end
